import{r as c,b as g,R as h,h as _,j as e,_ as u,i as j,k as N}from"./index-DPfIQIJl.js";import{b,a as f,m as v}from"./atoms-CGqSVeVB.js";import{a as S,S as x}from"./index-Cm-jbz-q.js";import{B as U,S as E}from"./Sidebar-N-ctC8-k.js";import"./SubscriptionInfo-C3bSvrb6.js";const L=()=>{const[s,t]=c.useState(null),[a,r]=c.useState(!1),[n,l]=c.useState(null);return c.useEffect(()=>{(async()=>{r(!0);try{const o=await g.get("/user/me");t(o.data)}catch(o){l(o)}finally{r(!1)}})()},[]),{userDetails:s,loading:a,error:n}},A=()=>{const[s,t]=h(b),a=_(f),r=n=>{const l=n.target.value.toLowerCase();if(t(l),!l){a([]);return}};return e.jsx("form",{className:"w-full mx-auto mb-3",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none",children:e.jsx("svg",{className:"w-4 h-4 text-gray-500 dark:text-gray-400","aria-hidden":"true",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 20 20",children:e.jsx("path",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"})})}),e.jsx("input",{type:"search",id:"default-search",className:"block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-[#6161ff] focus:border-[#6161ff] ",placeholder:"Search Users...",onChange:r,value:s,required:!0})]})})},D=()=>{const[s,t]=c.useState(!1),[a,r]=c.useState([]);return c.useEffect(()=>{(async()=>{t(!0);try{const l=await g.get("/chat/mychats");r(l.data)}catch(l){u.error(l.message)}finally{t(!1)}})()},[]),{loading:s,conversations:a}},I=s=>{const[t,a]=c.useState(!1),[r,n]=c.useState([]);return c.useEffect(()=>{s?(async()=>{a(!0);try{const i=await g.get("/user/all",{params:{search:s}});n(i.data)}catch{u.error("Failed to fetch users")}finally{a(!1)}})():n([])},[s]),{loading:t,users:r}},R=({n:s})=>Array(s).fill(0).map((t,a)=>e.jsx(S,{baseColor:"#cacccf",highlightColor:"#e6e3e3",children:e.jsxs("div",{className:"flex m-1 py-3 px-5 rounded-lg items-center",children:[e.jsx(x,{circle:!0,width:40,height:40,className:"mr-3"}),e.jsx("div",{className:"text-lg font-bold",children:e.jsx(x,{width:270,height:20})})]})})),T=()=>{const[s,t]=h(f),[a,r]=h(b),{loading:n,conversations:l}=D(),{loading:i,users:o}=I(a);let m=[];a?m=i?[]:o:m=n?[]:l;const p=d=>{t(d),r("")},C=d=>d.replace(/\w\S*/g,function(w){return w.charAt(0).toUpperCase()+w.substr(1).toLowerCase()}),{onlineUsers:k}=j(),M=d=>k.includes(d);return e.jsxs("div",{className:"",children:[n&&e.jsx(R,{n:10}),m.map(d=>e.jsxs("div",{className:"flex hover:bg-[#6161ff] hover:text-white hover:cursor-pointer m-1 py-3 px-5 rounded-lg items-center border border-gray-300",onClick:()=>p(d),children:[e.jsxs("div",{className:"hidden",children:["ID: ",d._id]}),e.jsxs("div",{className:"relative w-16 h-16 rounded-full mr-3 bg-gray-300 flex justify-center items-center",children:[e.jsx("img",{className:"w-14 h-14",src:d.profilePic,alt:"User Img"}),e.jsx("span",{className:`bottom-0 left-12 absolute w-4 h-4 ${M(d._id)?"bg-green-400":"bg-red-400"} border-2 border-white dark:border-gray-800 rounded-full`})]}),e.jsx("div",{className:"text-lg font-bold",children:C(d.username)}),e.jsxs("div",{className:"hidden",children:["Email: ",d.email]})]},d._id))]})},F=()=>e.jsxs("div",{className:"border-r p-4 border-white flex h-screen flex-col",children:[e.jsx(A,{}),e.jsx("div",{className:"divider px-3"}),e.jsx(T,{})]}),P=()=>{const[s,t]=c.useState(!1),[a,r]=h(v),n=N(f);return c.useEffect(()=>{const l=async()=>{t(!0);try{const o=(await g.get(`/chat/message/${n._id}`)).data;if(o.error)throw new Error(o.error);r(o)}catch(i){u.error(i.message)}finally{t(!1)}};n!=null&&n._id&&l()},[n==null?void 0:n._id,r]),{messages:a,loading:s}},W=()=>{const{socket:s}=j(),[t,a]=h(v);c.useEffect(()=>(s==null||s.on("newMessage",r=>{r.shouldShake=!0,a([...t,r])}),()=>s==null?void 0:s.off("newMessage")),[s,a,t])};function $(s){const t=new Date(s),a=y(t.getHours()),r=y(t.getMinutes());return`${a}:${r}`}function y(s){return s.toString().padStart(2,"0")}const B=({message:s})=>{const[t]=h(f),a=localStorage.getItem("user"),r=JSON.parse(a),n=s.senderId===r._id,l=n?r==null?void 0:r.profilePic:t==null?void 0:t.profilePic,i=n?r==null?void 0:r.username:t==null?void 0:t.username,o=$(s.createdAt);return s.shouldShake,e.jsx(e.Fragment,{children:n?e.jsx("div",{className:"flex justify-end",children:e.jsxs("div",{className:"flex items-end gap-2.5 m-3 max-w-[1000px]",children:[e.jsxs("div",{className:"flex flex-col w-full max-w-[600px] leading-1.5 p-4 border-gray-200  bg-[#6161ff] rounded-e-xl rounded-xl",style:{overflowWrap:"break-word"},children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx("span",{className:"text-sm font-semibold text-white ",children:i}),e.jsx("span",{className:"text-sm font-normal text-gray-200 ",children:o})]}),e.jsx("div",{className:"text-sm font-normal py-2.5 text-white ",children:s.message})]}),e.jsx("img",{className:"w-8 h-8 rounded-full",src:l,alt:"image"})]})}):e.jsxs("div",{className:"flex items-start gap-2.5 m-3",children:[e.jsx("img",{className:"w-8 h-8 rounded-full",src:l,alt:"image"}),e.jsxs("div",{className:"flex flex-col w-full max-w-[200px] leading-1.5 p-4 border-gray-200 rounded-e-xl rounded-xl bg-[#3a3a3a]",children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-100 ",children:i}),e.jsx("span",{className:"text-sm font-normal text-white",children:o})]}),e.jsx("p",{className:"text-sm font-normal py-2.5 text-gray-100 ",children:s.message})]})]})})},G=({n:s})=>Array(s).fill(0).map((t,a)=>e.jsxs(S,{baseColor:"#cacccf",highlightColor:"#e6e3e3",children:[e.jsx("div",{className:"flex justify-start  ",children:e.jsxs("div",{className:"flex items-end gap-2.5 m-3 max-w-[1000px] w-[40%]",children:[e.jsx(x,{circle:!0,width:32,height:32}),e.jsxs("div",{className:"flex flex-col w-full max-w-[600px] leading-1.5 p-4 border-gray-200 rounded-xl",style:{overflowWrap:"break-word"},children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(x,{width:100,height:20}),e.jsx(x,{width:80,height:20})]}),e.jsx(x,{count:3,height:20})]})]})}),e.jsx("div",{className:"flex justify-end  ",children:e.jsxs("div",{className:"flex items-end gap-2.5 m-3 max-w-[1000px] w-[40%]",children:[e.jsxs("div",{className:"flex flex-col w-full max-w-[600px] leading-1.5 p-4 border-gray-200 rounded-xl",style:{overflowWrap:"break-word"},children:[e.jsxs("div",{className:"flex items-center space-x-2 rtl:space-x-reverse",children:[e.jsx(x,{width:100,height:20}),e.jsx(x,{width:80,height:20})]}),e.jsx(x,{count:3,height:20})]}),e.jsx(x,{circle:!0,width:32,height:32})]})})]})),O=()=>{const{messages:s,loading:t}=P();W();const a=c.useRef();return c.useEffect(()=>{setTimeout(()=>{var r;(r=a.current)==null||r.scrollIntoView({behavior:"smooth"})},100)},[s]),e.jsxs("div",{className:"px-4 flex-1 overflow-auto",children:[t&&e.jsx(G,{n:3}),!t&&s.length>0&&s.map(r=>e.jsx("div",{ref:a,children:e.jsx(B,{message:r})},r._id)),!t&&s.length===0&&e.jsx("p",{className:"text-center",children:"Send a message to start the conversation"})]})},Z=()=>{const[s,t]=c.useState(!1),a=N(f),[r,n]=h(v);return{sendMessage:async i=>{t(!0);try{const m=(await g.post(`/chat/message/send/${a._id}`,{message:i})).data;if(m.error)throw new Error(m.error);const p=Array.isArray(r)?[...r,m]:[m];n(p)}catch(o){u.error(o.message)}finally{t(!1)}},loading:s}},q=()=>{const[s,t]=c.useState(""),{loading:a,sendMessage:r}=Z(),n=async l=>{l.preventDefault(),s&&(await r(s),t(""))};return e.jsx("form",{className:"px-4  my-3",onSubmit:n,children:e.jsxs("div",{className:"w-full relative",children:[e.jsx("input",{type:"text",className:"border text-base rounded-lg block w-full p-3 text-black bg-gray-100",placeholder:"Type Your Message...",value:s,onChange:l=>t(l.target.value)}),e.jsx("button",{type:"submit",className:"absolute inset-y-0 end-0 flex items-center pe-3 ",children:a?e.jsx("div",{className:"loading loading-spinner"}):e.jsx(U,{className:"text-black"})})]})})},H=()=>{const[s,t]=h(f);c.useEffect(()=>()=>t([]),[t]);const{onlineUsers:a}=j(),r=n=>a.includes(n);return e.jsx("div",{className:"w-full flex flex-col",children:s.length===0?e.jsx(J,{}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 bg-gray-300 flex items-center",children:[e.jsx("img",{src:s.profilePic,className:"h-16",alt:""}),e.jsxs("span",{className:"text-gray-900 text-2xl font-bold ml-2",children:[s.username,r(s._id)?"Online":"Offline"]})]}),e.jsx(O,{}),e.jsx(q,{})]})})},J=()=>{const{userDetails:s,loading:t}=L();return e.jsx("div",{className:"flex items-center justify-center w-full h-full",children:e.jsxs("div",{className:"px-4 text-center sm:text-lg md:text-xl text-black font-semibold flex flex-col items-center gap-2",children:[e.jsxs("p",{children:["Welcome ",s==null?void 0:s.username]}),e.jsx("p",{children:"Select a chat to stsart messaging"})]})})},X=()=>e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-AlbertSans w-[20rem] left-0 top-0 fixed h-full bg-[#f3f4f6]",children:e.jsx(E,{})}),e.jsxs("div",{className:"top-0 left-[20rem] h-full relative w-auto flex rounded-lg overgflow-hidden bg-gray-400 bg-clip-padding backdrop-filter backdrop-blur-lg bg-opacity-20",style:{width:"calc(100% - 20rem)"},children:[e.jsx("div",{className:"w-[27vw] min-w-[250px]",children:e.jsx(F,{})}),e.jsx(H,{})]})]});export{X as default};
